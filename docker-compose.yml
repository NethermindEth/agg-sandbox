services:
  anvil-mainnet:
    build:
      context: ./images
      dockerfile: Dockerfile.anvil
    ports:
      - "8545:8545"
    networks:
      - anvil-network
    environment:
      - ENABLE_FORK_MODE=${ENABLE_FORK_MODE:-false}
      - FORK_URL_MAINNET=${FORK_URL_MAINNET:-}
      - CHAIN_ID_MAINNET=${CHAIN_ID_MAINNET:-1}
    healthcheck:
      test: ["CMD-SHELL", "timeout 1 bash -c '</dev/tcp/localhost/8545'"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  anvil-polygon:
    build:
      context: ./images
      dockerfile: Dockerfile.anvil
    ports:
      - "8546:8545"
    networks:
      - anvil-network
    environment:
      - ENABLE_FORK_MODE=${ENABLE_FORK_MODE:-false}
      - FORK_URL_AGGLAYER_1=${FORK_URL_AGGLAYER_1:-}
      - CHAIN_ID_AGGLAYER_1=${CHAIN_ID_AGGLAYER_1:-1101}
    healthcheck:
      test: ["CMD-SHELL", "timeout 1 bash -c '</dev/tcp/localhost/8545'"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  aggkit:
    image: ametelnethermind/aggkit:latest
    depends_on:
      anvil-mainnet:
        condition: service_healthy
      anvil-polygon:
        condition: service_healthy
    networks:
      - anvil-network
    volumes:
      - ./config:/app/config
      - aggkit-data:/data
    environment:
      - RPC_URL_1=http://anvil-mainnet:8545
      - RPC_URL_2=http://anvil-polygon:8545

  contract-deployer:
    build:
      context: .
      dockerfile: images/Dockerfile.deploy
    depends_on:
      anvil-mainnet:
        condition: service_healthy
      anvil-polygon:
        condition: service_healthy
    networks:
      - anvil-network
    environment:
      - RPC_URL_1=http://anvil-mainnet:8545
      - RPC_URL_2=http://anvil-polygon:8545
    volumes:
      - ./.env:/app/output/deployed-contracts.env

networks:
  anvil-network:
    driver: bridge

volumes:
  aggkit-data:
